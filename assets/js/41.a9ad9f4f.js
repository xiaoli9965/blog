(window.webpackJsonp=window.webpackJsonp||[]).push([[41],{476:function(t,s,a){"use strict";a.r(s);var e=a(34),n=Object(e.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),a("p",[a("strong",[t._v("几种实现分布式锁的方式")])]),t._v(" "),a("ul",[a("li",[t._v("基于数据库实现分布式锁；")]),t._v(" "),a("li",[t._v("🌞基于缓存（Redis等）实现分布式锁；")]),t._v(" "),a("li",[t._v("💥基于Zookeeper实现分布式锁；")])])]),t._v(" "),a("h2",{attrs:{id:"_1-几个核心要素"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-几个核心要素"}},[t._v("#")]),t._v(" 1. 几个核心要素")]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),a("ul",[a("li",[t._v("加锁")]),t._v(" "),a("li",[t._v("解锁")]),t._v(" "),a("li",[t._v("锁超时")]),t._v(" "),a("li",[t._v("保证原子性")])])]),t._v(" "),a("h2",{attrs:{id:"_3-基于zookeeper实现"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-基于zookeeper实现"}},[t._v("#")]),t._v(" 3. 基于Zookeeper实现")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[t._v("这是雅虎研究员设计 Zookeeper 的初衷。利用 Zookeeper 的临时顺序节点，可以轻松实现分布式锁。\n")])])]),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("基于临时有序节点实现")]),t._v(" "),a("p",[a("strong",[t._v("临时有序节点的几个特性")])]),t._v(" "),a("ul",[a("li",[t._v("产生节点是有序的")]),t._v(" "),a("li",[t._v("客户端断开连接会自动删除当前节点")])])]),t._v(" "),a("p",[t._v("参考 "),a("a",{attrs:{href:"https://mp.weixin.qq.com/s/u8QDlrDj3Rl1YjY4TyKMCA",target:"_blank",rel:"noopener noreferrer"}},[t._v(" 程序员小灰 博客 "),a("OutboundLink")],1)]),t._v(" "),a("h3",{attrs:{id:"_3-1-获取锁"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-获取锁"}},[t._v("#")]),t._v(" 3.1. 获取锁")]),t._v(" "),a("ul",[a("li",[t._v("1.当客户端想要获取锁时,需要在ZK某个节点("),a("code",[t._v("暂定PL")]),t._v(")下创建一个"),a("strong",[t._v("临时顺序节点")]),t._v(" "),a("code",[t._v("lock1")])]),t._v(" "),a("li",[t._v("2.然后获取PL节点下所有子节点判断自己创建的是否是第一个节点")]),t._v(" "),a("li",[t._v("3.如果自己是第一个节点,代表获取锁成功")]),t._v(" "),a("li",[t._v("4.如果不是第一个节点就设置一个"),a("code",[t._v("Watcher")]),t._v(",监听前一个节点是否存在 "),a("code",[t._v("抢锁失败,进入等待")])])]),t._v(" "),a("blockquote",[a("p",[t._v("获取锁失败设置Watcher监听前一个节点这样就会形成一个FIFO队列,类似AQS")])]),t._v(" "),a("h3",{attrs:{id:"_3-2-释放锁"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-释放锁"}},[t._v("#")]),t._v(" 3.2. 释放锁")]),t._v(" "),a("ul",[a("li",[t._v("当锁用完时,客户端执行删除命令,删除自身创建的锁\n"),a("ul",[a("li",[t._v("如果在执行过程中客户端崩溃会自动释放锁(ZK临时节点特性,客户端断开会自动清除所创建节点)")])])]),t._v(" "),a("li",[t._v("客户端1删除掉节点后,"),a("code",[t._v("客户端2")]),t._v("通过Wacther感知"),a("code",[t._v("Lock1")]),t._v("被删除")]),t._v(" "),a("li",[t._v("客户端2获取到了锁,开始执行逻辑")])]),t._v(" "),a("h3",{attrs:{id:"_3-3-zookeeper-和-redis-分布式锁的比较"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-zookeeper-和-redis-分布式锁的比较"}},[t._v("#")]),t._v(" 3.3. Zookeeper 和 Redis 分布式锁的比较")]),t._v(" "),a("p",[t._v(":::\n"),a("img",{attrs:{src:"http://md.yike.link/20200711202456_QwnuDs_Screenshot.jpeg",alt:"Zookeeper 和 Redis 分布式锁的比较"}}),t._v("\n:::")]),t._v(" "),a("h2",{attrs:{id:"_4-基于redis实现"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-基于redis实现"}},[t._v("#")]),t._v(" 4. 基于Redis实现")]),t._v(" "),a("p",[t._v("参考 "),a("a",{attrs:{href:"https://mp.weixin.qq.com/s/WigpT0yjD2kCwtx91paT0g",target:"_blank",rel:"noopener noreferrer"}},[t._v("程序员小灰 博客"),a("OutboundLink")],1)]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("获取锁")]),t._v(" "),a("ul",[a("li",[t._v("使用 "),a("code",[t._v("set（key，1，30，NX）")]),t._v(" 来设置一把锁")]),t._v(" "),a("li",[t._v("如果返回ok就代表获取到了锁, 如果不是就在一定时间内重试几次获取锁")])]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" threadId "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Thread")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("currentThread")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nset（key，threadId ，"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("30")]),t._v("，NX）\n")])])])]),t._v(" "),a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"custom-block-title"},[t._v("释放锁")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" luaScript "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("\"if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end\"")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nredisClient"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("eval")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("luaScript "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Collections")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("singletonList")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Collections")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("singletonList")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("threadId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])])])])}),[],!1,null,null,null);s.default=n.exports}}]);